{"version":3,"sources":["../../../src/commands/apply/configureIOSProjectAsync.ts"],"names":["configureIOSProjectAsync","projectRoot","bundleIdentifier","IOSConfig","BundleIdenitifer","setBundleIdentifierForPbxproj","exp","skipSDKVersionRequirement","username","UserManager","getCurrentUsernameAsync","Google","setGoogleServicesFile","DeviceFamily","setDeviceFamily","modifyInfoPlistAsync","infoPlist","CustomInfoPlistEntries","setCustomInfoPlistEntries","Branch","setBranchApiKey","Facebook","setFacebookConfig","setGoogleConfig","Name","setDisplayName","Orientation","setOrientation","RequiresFullScreen","setRequiresFullScreen","Scheme","setScheme","UserInterfaceStyle","setUserInterfaceStyle","UsesNonExemptEncryption","setUsesNonExemptEncryption","Version","setBuildNumber","setVersion","modifyExpoPlistAsync","expoPlist","Updates","setUpdatesConfig","modifyEntitlementsPlistAsync","entitlementsPlist","Entitlements","setCustomEntitlementsEntries","setICloudEntitlement","setAppleSignInEntitlement","setAccessesContactNotes","setAssociatedDomains","e","WarningAggregator","addWarningIOS","Icons","setIconsAsync","SplashScreen","setSplashScreenAsync","Locales","setLocalesAsync","callback","entitlementsPath","getEntitlementsPath","directory","path","dirname","filename","basename","IosPlist","modifyAsync","cleanBackupAsync","iosProjectDirectory","getIOSPaths","supportingDirectory","join","error","sanitizedName","name","replace","normalize","projectName","Error","iconPath"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AAEe,eAAeA,wBAAf,CAAwCC,WAAxC,EAA6D;AAC1E;AACA,QAAMC,gBAAgB,GAAG,MAAM,wDAA+BD,WAA/B,CAA/B;;AACAE,sBAAUC,gBAAV,CAA2BC,6BAA3B,CAAyDJ,WAAzD,EAAsEC,gBAAtE;;AAEA,QAAM;AAAEI,IAAAA;AAAF,MAAU,yBAAUL,WAAV,EAAuB;AAAEM,IAAAA,yBAAyB,EAAE;AAA7B,GAAvB,CAAhB;AACA,QAAMC,QAAQ,GAAG,MAAMC,mBAAYC,uBAAZ,EAAvB;;AAEAP,sBAAUQ,MAAV,CAAiBC,qBAAjB,CAAuCN,GAAvC,EAA4CL,WAA5C;;AACAE,sBAAUU,YAAV,CAAuBC,eAAvB,CAAuCR,GAAvC,EAA4CL,WAA5C,EAT0E,CAW1E;;;AACA,QAAMc,oBAAoB,CAACd,WAAD,EAAce,SAAS,IAAI;AACnDA,IAAAA,SAAS,GAAGb,oBAAUc,sBAAV,CAAiCC,yBAAjC,CAA2DZ,GAA3D,EAAgEU,SAAhE,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUgB,MAAV,CAAiBC,eAAjB,CAAiCd,GAAjC,EAAsCU,SAAtC,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUkB,QAAV,CAAmBC,iBAAnB,CAAqChB,GAArC,EAA0CU,SAA1C,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUQ,MAAV,CAAiBY,eAAjB,CAAiCjB,GAAjC,EAAsCU,SAAtC,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUqB,IAAV,CAAeC,cAAf,CAA8BnB,GAA9B,EAAmCU,SAAnC,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUuB,WAAV,CAAsBC,cAAtB,CAAqCrB,GAArC,EAA0CU,SAA1C,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUyB,kBAAV,CAA6BC,qBAA7B,CAAmDvB,GAAnD,EAAwDU,SAAxD,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAU2B,MAAV,CAAiBC,SAAjB,CAA2BzB,GAA3B,EAAgCU,SAAhC,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAU6B,kBAAV,CAA6BC,qBAA7B,CAAmD3B,GAAnD,EAAwDU,SAAxD,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAU+B,uBAAV,CAAkCC,0BAAlC,CAA6D7B,GAA7D,EAAkEU,SAAlE,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUiC,OAAV,CAAkBC,cAAlB,CAAiC/B,GAAjC,EAAsCU,SAAtC,CAAZ;AACAA,IAAAA,SAAS,GAAGb,oBAAUiC,OAAV,CAAkBE,UAAlB,CAA6BhC,GAA7B,EAAkCU,SAAlC,CAAZ;AAEA,WAAOA,SAAP;AACD,GAfyB,CAA1B,CAZ0E,CA6B1E;;AACA,QAAMuB,oBAAoB,CAACtC,WAAD,EAAcuC,SAAS,IAAI;AACnDA,IAAAA,SAAS,GAAGrC,oBAAUsC,OAAV,CAAkBC,gBAAlB,CAAmCpC,GAAnC,EAAwCkC,SAAxC,EAAmDhC,QAAnD,CAAZ;AACA,WAAOgC,SAAP;AACD,GAHyB,CAA1B,CA9B0E,CAmC1E;;AACA,MAAI;AACF;AACA,UAAMG,4BAA4B,CAAC1C,WAAD,EAAc2C,iBAAiB,IAAI;AACnEA,MAAAA,iBAAiB,GAAGzC,oBAAU0C,YAAV,CAAuBC,4BAAvB,CAClBxC,GADkB,EAElBsC,iBAFkB,CAApB,CADmE,CAMnE;;AACAA,MAAAA,iBAAiB,GAAGzC,oBAAU0C,YAAV,CAAuBE,oBAAvB,CAClBzC,GADkB,EAElB,wBAFkB,EAGlBsC,iBAHkB,CAApB;AAMAA,MAAAA,iBAAiB,GAAGzC,oBAAU0C,YAAV,CAAuBG,yBAAvB,CAAiD1C,GAAjD,EAAsDsC,iBAAtD,CAApB;AACAA,MAAAA,iBAAiB,GAAGzC,oBAAU0C,YAAV,CAAuBI,uBAAvB,CAA+C3C,GAA/C,EAAoDsC,iBAApD,CAApB;AACAA,MAAAA,iBAAiB,GAAGzC,oBAAU0C,YAAV,CAAuBK,oBAAvB,CAA4C5C,GAA5C,EAAiDsC,iBAAjD,CAApB;AACA,aAAOA,iBAAP;AACD,KAjBiC,CAAlC;AAkBD,GApBD,CAoBE,OAAOO,CAAP,EAAU;AACVC,gCAAkBC,aAAlB,CACE,cADF,EAEE,kLAFF;AAID,GA7DyE,CA+D1E;;;AACA,QAAMlD,oBAAUmD,KAAV,CAAgBC,aAAhB,CAA8BjD,GAA9B,EAAmCL,WAAnC,CAAN;AACA,QAAME,oBAAUqD,YAAV,CAAuBC,oBAAvB,CAA4CnD,GAA5C,EAAiDL,WAAjD,CAAN;AACA,QAAME,oBAAUuD,OAAV,CAAkBC,eAAlB,CAAkCrD,GAAlC,EAAuCL,WAAvC,CAAN;AACD;;AAED,eAAe0C,4BAAf,CAA4C1C,WAA5C,EAAiE2D,QAAjE,EAAgG;AAC9F,QAAMC,gBAAgB,GAAG1D,oBAAU0C,YAAV,CAAuBiB,mBAAvB,CAA2C7D,WAA3C,CAAzB;;AACA,QAAM8D,SAAS,GAAGC,gBAAKC,OAAL,CAAaJ,gBAAb,CAAlB;;AACA,QAAMK,QAAQ,GAAGF,gBAAKG,QAAL,CAAcN,gBAAd,EAAgC,OAAhC,CAAjB;;AACA,QAAMO,gBAASC,WAAT,CAAqBN,SAArB,EAAgCG,QAAhC,EAA0CN,QAA1C,CAAN;AACA,QAAMQ,gBAASE,gBAAT,CAA0BP,SAA1B,EAAqCG,QAArC,EAA+C,KAA/C,CAAN;AACD;;AAED,eAAenD,oBAAf,CAAoCd,WAApC,EAAyD2D,QAAzD,EAAwF;AACtF,QAAM;AAAEW,IAAAA;AAAF,MAA0BC,WAAW,CAACvE,WAAD,CAA3C;AACA,QAAMmE,gBAASC,WAAT,CAAqBE,mBAArB,EAA0C,MAA1C,EAAkDX,QAAlD,CAAN;AACA,QAAMQ,gBAASE,gBAAT,CAA0BC,mBAA1B,EAA+C,MAA/C,EAAuD,KAAvD,CAAN;AACD;;AAED,eAAehC,oBAAf,CAAoCtC,WAApC,EAAyD2D,QAAzD,EAAwF;AACtF,QAAM;AAAEW,IAAAA;AAAF,MAA0BC,WAAW,CAACvE,WAAD,CAA3C;;AACA,QAAMwE,mBAAmB,GAAGT,gBAAKU,IAAL,CAAUH,mBAAV,EAA+B,YAA/B,CAA5B;;AACA,MAAI;AACF,UAAMH,gBAASC,WAAT,CAAqBI,mBAArB,EAA0C,MAA1C,EAAkDb,QAAlD,CAAN;AACD,GAFD,CAEE,OAAOe,KAAP,EAAc;AACdvB,gCAAkBC,aAAlB,CACE,SADF,EAEE,gJAFF,EAGE,oEAHF;AAKD,GARD,SAQU;AACR,UAAMe,gBAASE,gBAAT,CAA0BG,mBAA1B,EAA+C,MAA/C,EAAuD,KAAvD,CAAN;AACD;AACF,C,CAED;;;AACA,SAASG,aAAT,CAAuBC,IAAvB,EAAqC;AACnC,SAAOA,IAAI,CACRC,OADI,CACI,SADJ,EACe,EADf,EAEJC,SAFI,CAEM,KAFN,EAGJD,OAHI,CAGI,kBAHJ,EAGwB,EAHxB,CAAP;AAID,C,CAED;AACA;AACA;AACA;;;AACA,SAASN,WAAT,CAAqBvE,WAArB,EAA0C;AACxC,MAAI+E,WAA0B,GAAG,IAAjC,CADwC,CAGxC;;AACA,MAAI;AACFA,IAAAA,WAAW,GAAG,iCAAe/E,WAAf,CAAd;AACD,GAFD,CAEE,gBAAM;AACN;AACA,UAAM;AAAEK,MAAAA;AAAF,QAAU,yBAAUL,WAAV,EAAuB;AAAEM,MAAAA,yBAAyB,EAAE;AAA7B,KAAvB,CAAhB;AAEAyE,IAAAA,WAAW,GAAG1E,GAAG,CAACuE,IAAlB;;AACA,QAAI,CAACG,WAAL,EAAkB;AAChB,YAAM,IAAIC,KAAJ,CAAU,sDAAV,CAAN;AACD;;AACDD,IAAAA,WAAW,GAAGJ,aAAa,CAACI,WAAD,CAA3B;AACD;;AAED,QAAMT,mBAAmB,GAAGP,gBAAKU,IAAL,CAAUzE,WAAV,EAAuB,KAAvB,EAA8B+E,WAA9B,CAA5B;;AACA,QAAME,QAAQ,GAAGlB,gBAAKU,IAAL,CAAUH,mBAAV,EAA+B,iBAA/B,EAAkD,oBAAlD,CAAjB;;AAEA,SAAO;AACLS,IAAAA,WADK;AAELT,IAAAA,mBAFK;AAGLW,IAAAA;AAHK,GAAP;AAKD","sourcesContent":["import { IOSConfig, WarningAggregator, getConfig } from '@expo/config';\nimport { getProjectName } from '@expo/config/build/ios/utils/Xcodeproj';\nimport { IosPlist, UserManager } from '@expo/xdl';\nimport path from 'path';\n\nimport { getOrPromptForBundleIdentifier } from '../eject/ConfigValidation';\n\nexport default async function configureIOSProjectAsync(projectRoot: string) {\n  // Check bundle ID before reading the config because it may mutate the config if the user is prompted to define it.\n  const bundleIdentifier = await getOrPromptForBundleIdentifier(projectRoot);\n  IOSConfig.BundleIdenitifer.setBundleIdentifierForPbxproj(projectRoot, bundleIdentifier);\n\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const username = await UserManager.getCurrentUsernameAsync();\n\n  IOSConfig.Google.setGoogleServicesFile(exp, projectRoot);\n  IOSConfig.DeviceFamily.setDeviceFamily(exp, projectRoot);\n\n  // Configure the Info.plist\n  await modifyInfoPlistAsync(projectRoot, infoPlist => {\n    infoPlist = IOSConfig.CustomInfoPlistEntries.setCustomInfoPlistEntries(exp, infoPlist);\n    infoPlist = IOSConfig.Branch.setBranchApiKey(exp, infoPlist);\n    infoPlist = IOSConfig.Facebook.setFacebookConfig(exp, infoPlist);\n    infoPlist = IOSConfig.Google.setGoogleConfig(exp, infoPlist);\n    infoPlist = IOSConfig.Name.setDisplayName(exp, infoPlist);\n    infoPlist = IOSConfig.Orientation.setOrientation(exp, infoPlist);\n    infoPlist = IOSConfig.RequiresFullScreen.setRequiresFullScreen(exp, infoPlist);\n    infoPlist = IOSConfig.Scheme.setScheme(exp, infoPlist);\n    infoPlist = IOSConfig.UserInterfaceStyle.setUserInterfaceStyle(exp, infoPlist);\n    infoPlist = IOSConfig.UsesNonExemptEncryption.setUsesNonExemptEncryption(exp, infoPlist);\n    infoPlist = IOSConfig.Version.setBuildNumber(exp, infoPlist);\n    infoPlist = IOSConfig.Version.setVersion(exp, infoPlist);\n\n    return infoPlist;\n  });\n\n  // Configure Expo.plist\n  await modifyExpoPlistAsync(projectRoot, expoPlist => {\n    expoPlist = IOSConfig.Updates.setUpdatesConfig(exp, expoPlist, username);\n    return expoPlist;\n  });\n\n  // TODO: fix this on Windows! We will ignore errors for now so people can just proceed\n  try {\n    // Configure entitlements/capabilities\n    await modifyEntitlementsPlistAsync(projectRoot, entitlementsPlist => {\n      entitlementsPlist = IOSConfig.Entitlements.setCustomEntitlementsEntries(\n        exp,\n        entitlementsPlist\n      );\n\n      // TODO: We don't have a mechanism for getting the apple team id here yet\n      entitlementsPlist = IOSConfig.Entitlements.setICloudEntitlement(\n        exp,\n        'TODO-GET-APPLE-TEAM-ID',\n        entitlementsPlist\n      );\n\n      entitlementsPlist = IOSConfig.Entitlements.setAppleSignInEntitlement(exp, entitlementsPlist);\n      entitlementsPlist = IOSConfig.Entitlements.setAccessesContactNotes(exp, entitlementsPlist);\n      entitlementsPlist = IOSConfig.Entitlements.setAssociatedDomains(exp, entitlementsPlist);\n      return entitlementsPlist;\n    });\n  } catch (e) {\n    WarningAggregator.addWarningIOS(\n      'entitlements',\n      'iOS entitlements could not be applied. Please ensure that contact notes, Apple Sign In, and associated domains entitlements are properly configured if you use them in your app.'\n    );\n  }\n\n  // Other\n  await IOSConfig.Icons.setIconsAsync(exp, projectRoot);\n  await IOSConfig.SplashScreen.setSplashScreenAsync(exp, projectRoot);\n  await IOSConfig.Locales.setLocalesAsync(exp, projectRoot);\n}\n\nasync function modifyEntitlementsPlistAsync(projectRoot: string, callback: (plist: any) => any) {\n  const entitlementsPath = IOSConfig.Entitlements.getEntitlementsPath(projectRoot);\n  const directory = path.dirname(entitlementsPath);\n  const filename = path.basename(entitlementsPath, 'plist');\n  await IosPlist.modifyAsync(directory, filename, callback);\n  await IosPlist.cleanBackupAsync(directory, filename, false);\n}\n\nasync function modifyInfoPlistAsync(projectRoot: string, callback: (plist: any) => any) {\n  const { iosProjectDirectory } = getIOSPaths(projectRoot);\n  await IosPlist.modifyAsync(iosProjectDirectory, 'Info', callback);\n  await IosPlist.cleanBackupAsync(iosProjectDirectory, 'Info', false);\n}\n\nasync function modifyExpoPlistAsync(projectRoot: string, callback: (plist: any) => any) {\n  const { iosProjectDirectory } = getIOSPaths(projectRoot);\n  const supportingDirectory = path.join(iosProjectDirectory, 'Supporting');\n  try {\n    await IosPlist.modifyAsync(supportingDirectory, 'Expo', callback);\n  } catch (error) {\n    WarningAggregator.addWarningIOS(\n      'updates',\n      'Expo.plist configuration could not be applied. You will need to create Expo.plist if it does not exist and add Updates configuration manually.',\n      'https://docs.expo.io/bare/updating-your-app/#configuration-options'\n    );\n  } finally {\n    await IosPlist.cleanBackupAsync(supportingDirectory, 'Expo', false);\n  }\n}\n\n// TODO: come up with a better solution for using app.json expo.name in various places\nfunction sanitizedName(name: string) {\n  return name\n    .replace(/[\\W_]+/g, '')\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '');\n}\n\n// TODO: it's silly and kind of fragile that we look at app config to determine\n// the ios project paths. Overall this function needs to be revamped, just a\n// placeholder for now! Make this more robust when we support applying config\n// at any time (currently it's only applied on eject).\nfunction getIOSPaths(projectRoot: string) {\n  let projectName: string | null = null;\n\n  // Attempt to get the current ios folder name (apply).\n  try {\n    projectName = getProjectName(projectRoot);\n  } catch {\n    // If no iOS project exists then create a new one (eject).\n    const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n    projectName = exp.name;\n    if (!projectName) {\n      throw new Error('Your project needs a name in app.json/app.config.js.');\n    }\n    projectName = sanitizedName(projectName);\n  }\n\n  const iosProjectDirectory = path.join(projectRoot, 'ios', projectName);\n  const iconPath = path.join(iosProjectDirectory, 'Assets.xcassets', 'AppIcon.appiconset');\n\n  return {\n    projectName,\n    iosProjectDirectory,\n    iconPath,\n  };\n}\n"],"file":"configureIOSProjectAsync.js"}